---
title: "Haskell ã‚’ Dev Container ã§å‹•ã‹ã—ãŸã„"
emoji: "ğŸ˜"
type: "tech"
topics: ["haskell", "devcontainer", "docker"]
published: true
---

:::message
Dev Container ã§ Haskell ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã‚ˆã†ã¨ã—ãŸã‚‰æ€ã„ã®ã»ã‹æ²¼ã£ãŸã®ã§ï¼Œå‚™å¿˜éŒ²ã¨ã—ã¦æ›¸ã„ã¦ãŠã“ã†ã¨ã„ã†è¶£æ—¨ã®è¨˜äº‹ã«ãªã‚Šã¾ã™ï¼Haskell åˆå¿ƒè€…ãªã®ã§èª¤ã£ãŸæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ã‚‚ã—ãŠæ°—ã¥ãã®éš›ã¯ï¼Œå¤§å¤‰æç¸®ã§ã™ãŒã‚„ã•ã—ã„è¨€è‘‰ã§ã”æŒ‡æ‘˜ãã ã•ã„ã¾ã›ï¼
:::

# 1. Dev Container ã« Haskell ãƒ—ãƒªã‚»ãƒƒãƒˆãŒãªã„

Dev Container ã§ Haskell ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ï¼ŒãŠãã‚‰ãã¾ãšçœŸã£å…ˆã«ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰ Haskell ã‚’æ¢ãã†ã¨ã™ã‚‹ã§ã—ã‚‡ã†ï¼ãã—ã¦ãã®è©¦ã¿ã¯å¤±æ•—ã«çµ‚ã‚ã‚Šã¾ã™ï¼ã¨ã„ã†ã®ã‚‚ï¼Œ`has` ã¾ã§å…¥åŠ›ã—ãŸæ™‚ç‚¹ã§ï¼Œå€™è£œãŒ 0 ä»¶ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã™ï¼å®Ÿã¯ã™ã“ã—ä»¥å‰ã«ã¯ã‚ã£ãŸã‚ˆã†ãªã®ã§ã™ãŒï¼Œç¾åœ¨ã§ã¯å»ƒæ­¢ã•ã‚Œã¦ã—ã¾ã£ãŸã‚ˆã†ã§ã™ï¼š

https://github.com/microsoft/vscode-dev-containers/tree/main/containers/haskell

# 2. Haskell Feature ã ã¨æ‹¡å¼µæ©Ÿèƒ½ãŒã†ã¾ãå‹•ä½œã—ãªã„

Dev Container ã«ãƒ—ãƒªã‚»ãƒƒãƒˆãŒãªã„ã¨ãï¼Œæ¬¡ã«æ¢ã™ã¹ãã¯ Features ã§ã™ï¼ãã—ã¦å¹¸é‹ã«ã‚‚ Features ã«ã¯ Haskell ãŒã‚ã‚Šã¾ã—ãŸï¼ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã¨ï¼Œä¸€å¿œã® Haskell ç’°å¢ƒã‚’ Dev Container ã§æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

https://github.com/devcontainers-contrib/features/tree/main/src/haskell

ã—ã‹ã—ã“ã‚Œã§ä¸€ä»¶è½ç€ã¨ã„ã†ã‚ã‘ã«ã¯ã„ãã¾ã›ã‚“ã§ã—ãŸï¼Haskell ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨è‡ªä½“ã¯å‡ºæ¥ã‚‹ã®ã§ã™ãŒï¼ŒVisual Studio Code ã® Haskell æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨å•é¡ŒãŒç”Ÿã˜ãŸã®ã§ã™ï¼å…·ä½“çš„ã«ã¯ï¼Œæ¬¡ã®ã‚ˆã†ãª 2 ã¤ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼š

> Project requires GHCup but it isn't installed

> Cannot hlint the haskell file. The hlint program was not found. Use the 'haskell.hlint.executablePath' setting to configure the location of 'hlint'

https://marketplace.visualstudio.com/items?itemName=haskell.haskell

ãã†ã‹ãã†ã‹ï¼Œ`GHCup` ã¨ `hlint` ã¨ã„ã†ã‚„ã¤ã‚’è¿½åŠ ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚“ã ã­ï¼ãµã‚€ãµã‚€ï¼ãã—ã¦ Haskell Feature ã«ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã£ãŸã“ã¨ã‚’æ€ã„å‡ºã—ã¾ã™ï¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼š

| Options Id | Description | Type | Default Value |
|-----|-----|-----|-----|
| ghcVersion | Select the GHC (Glasgow Haskell Compiler) version to install. | string | recommended |
| cabalVersion | Select the Cabal (a system for building and packaging Haskell libraries and programs) version to install. | string | recommended |
| globalPackages | Packages to install via `cabal install`, such as `hlint` for linting. Separate with spaces. This will add significant initial build time. | string | - |
| installHLS | Install HLS, the Haskell Language Server. | boolean | true |
| downgradeGhcToSupportHls | This will downgrade GHC to the closest version supported by HLS. There is often a gap between a GHC release and tooling support. | boolean | true |
| installStack | Install Stack, a build tool for Haskell. | boolean | true |
| installStackGHCupHook | Enabling this means that stack won't install its own GHC versions, but uses GHCup's | boolean | true |
| adjustBash | whether to adjust PATH in bashrc (prepend) | boolean | true |

https://github.com/haskell/vscode-haskell#downloaded-binaries

ã»ã†ã»ã†ï¼`GHCup` ã¨ã‹ `hlint` ã¨ã‹ã„ã†æ–‡å­—åˆ—ãŒã‚ã‚‹ã—ãªã‚“ã¨ã‹ãªã‚Šãã†ï¼ã¨ã‚Šã‚ãˆãšè¨­å®šå…¨éƒ¨ç››ã‚Šã«ã—ã¦ç¢ºã‹ã‚ã¦ã¿ã‚ˆã†ï¼ã—ã‹ã—ç›®è«–è¦‹ã¯è¦‹äº‹ã«å¤–ã‚Œã¾ã—ãŸï¼ã—ã‹ã—ãªãœã ã‹ã‚ˆãã‚ã‹ã‚Šã¾ã›ã‚“ãŒï¼Œã¾ãã¨ã«ã‹ãã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè§£æ¶ˆã•ã‚Œãªã‹ã£ãŸã®ã§ã™ğŸ˜¢

:::message
å®Ÿã¯ã“ã“ã‚‰ã¸ã‚“ã®æ¤œè¨¼ãŒã¡ã‚‡ã£ã¨é›‘ã ã£ãŸã®ãŒæ°—ãŒã‹ã‚Šãªã®ã§ã™ãŒï¼Œã„ã¾ã•ã‚‰ã‚„ã‚Šç›´ã™ã®ã¯é¢å€’ãªã®ã§ã‚„ã‚Šã¾ã›ã‚“ï¼é–“é•ã£ã¦ãŸã‚‰ã”ã‚ã‚“ãªã•ã„ï¼
:::

# 3. å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚‚æ‹¡å¼µæ©Ÿèƒ½ãŒã†ã¾ãå‹•ä½œã—ãªã„

ã•ã¦ï¼Œãªã‚‹ã¹ã Dockerfile ã¯æ›¸ããŸããªã„ã®ã§ã™ï¼æ¬¡ã®ä¸€æ‰‹ã¯ï¼Œå…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ã“ã¨ã§ã™ï¼èª¿ã¹ã¦ã¿ã‚‹ã¨ï¼ŒHaskell ã‚‚å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒé…å¸ƒã•ã‚Œã¦ã„ã¾ã—ãŸï¼

https://hub.docker.com/_/haskell/

ã ãŒã—ã‹ã—ï¼Œæ‚²ã—ã„ã‹ãªï¼å…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚‚ `GHCup` ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã®ã§ã—ãŸï¼š

https://github.com/haskell/docker-haskell/blob/a20f832dd35d2f7ceff5337b41a7e37244e1c9e1/9.8/buster/Dockerfile

ã™ã¹ã¦èª­ã‚€ã®ã¯å¤§å¤‰ã ã¨æ€ã†ã®ã§ï¼Œã‹ã„ã¤ã¾ã‚“ã§è¦ç´„ã™ã‚Œã°ï¼Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹ã®ã‚‚ã®ã ã‘ã§ã—ãŸï¼š

- Stack
- Cabal
- GHC

ã¡ã‚‡ã£ã¨èª¿ã¹ãŸã ã‘ãªã‚“ã§ã™ãŒï¼Œã©ã†ã‚„ã‚‰ GHCup ã¨ Stack ã®æ©Ÿèƒ½ãŒä¸€éƒ¨ç«¶åˆã™ã‚‹ã‚‰ã—ãï¼Œæœ€è¿‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ Stack ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„ãŸã‚ï¼ŒGHCup ã¯ãŠå½¹å¾¡å…ã¨ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ï¼š

https://zenn.dev/mod_poppo/articles/haskell-setup-2023

# 4. `postCreateCommand` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

ã©ã†ã‚„ã‚‰ï¼Œå¤šå°‘ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯é¿ã‘ã‚‰ã‚Œãªã„ã‚ˆã†ã§ã™ï¼ã¾ãšã¯ `devcontainer.json` ã® `postCreateCommand` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã—ãŸï¼`GHCup` ã¨ `hlint` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼š

```sh
curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh && \
    cabal update && \
    cabal install hlint
```

ã—ã‹ã—ä¸€ç­‹ç¸„ã§ã¯ã„ãã¾ã›ã‚“ï¼`curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh` ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®é¸æŠãªã©ãŒå¯¾è©±çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ï¼Œãã®ã¾ã¾ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã®ç«‹ã¡ä¸Šã’ãŒä¸­æ–­ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã™ï¼éå¯¾è©±çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã«ã¯ï¼Œç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸï¼š

https://www.haskell.org/ghcup/guide/#customisation-of-the-installation-scripts

https://github.com/haskell/ghcup-hs/blob/63e714d1b1a0b1c059ba097c6e0b03cf6b6bd707/scripts/bootstrap/bootstrap-haskell#L7-L24

Dev Container ã® `remoteEnv` ã§ `BOOTSTRAP_HASKELL_NONINTERACTIVE` ã‚’è¨­å®šã—ã¾ã™ï¼ã“ã‚Œã§ã‚ˆã†ã‚„ãã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’æ™‚ã« `GHCup` ã¨ `hlint` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

# 5. HLS ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

ã—ã‹ã—ã¾ã å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸï¼ä¸Šè¨˜ã®è¨­å®šã§ Haskell ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é–‹ãã¨æ¬¡ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

> Need to download hls-2.7.0.0, continue?

ã“ã‚Œã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯ãªãï¼Œå˜ã«è³ªå•ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ï¼`hls` ã¨ã„ã†ã®ã¯ Haskell Language Server ã®ã“ã¨ã§ï¼Œå®Ÿã®ã¨ã“ã‚ Haskell æ‹¡å¼µæ©Ÿèƒ½ã®ã‚³ã‚¢æ©Ÿèƒ½ã¯ã“ã„ã¤ã‚‰ã—ã„ã®ã§ã™ï¼ã˜ã‚ƒã‚ GHCup ã¯ãªã‚“ã ã£ãŸã®ã‹ã¨ã„ã†ã¨ï¼ŒHLS ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã«å¿…è¦ã ã‹ã‚‰ã¨ã„ã†ã ã‘ã ã£ãŸã‚ˆã†ã§ã™ï¼

ã•ã¦ï¼Œ`Yes` ã‚’é¸æŠã™ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦æ™´ã‚Œã¦æ‹¡å¼µæ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ã—ã‹ã—ï¼Œã›ã£ã‹ãã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã«ã‚³ãƒ³ãƒ†ãƒŠã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œçµã—ãªã„ã®ã¯ãªã‚“ã‹é•ã†æ°—ãŒã—ã¾ã™ï¼ãã“ã§ï¼ŒHLS ã‚‚ `postCreateCommand` ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸï¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼š

```sh
curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh && \
    ghcup install hls 2.7.0.0 && \
    cabal update && \
    cabal install hlint
```

ã—ã‹ã—ã¾ã ä¸ååˆ†ã§ã™ï¼GHCup ã®ãƒ‘ã‚¹ã‚’é€šã™å¿…è¦ãŒã‚ã‚‹ã®ã§ã—ãŸï¼`remoteEnv` ã§ `PATH` ã« GHCup ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼ã“ã‚Œã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯æˆåŠŸã™ã‚‹ã¯ãšã§ã™ï¼

# 6. GHC ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

ã—ã‹ã—ï¼Œã“ã®çŠ¶æ…‹ã§ã‚‚ Haskell ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é–‹ãã¨æ¬¡ã®ã‚ˆã†ãªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

> Need to download ghc-9.8.2, continue?

ã¤ã¾ã‚Šï¼Œå¯¾å¿œã—ã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® GHC ã‚’ä½¿ãˆã¨ã„ã†ã“ã¨ã§ã™ã­ï¼ã“ã‚Œã‚‚ï¼Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã§ãªãï¼Œã‚³ãƒ³ãƒ†ãƒŠå´ã§ã‚ã‚‰ã‹ã˜ã‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠããŸã„ã¨ã“ã‚ã§ã™ï¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ã¯ã•ã‚‰ã«æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```sh
curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh  && \
    ghcup install ghc 9.8.2 && \
    ghcup install hls 2.7.0.0 && \
    cabal update && \
    cabal install hlint
```

# 7. çµå±€ Dockerfile ã«æ›¸ããªãŠã™

Dev Container ã® `postCreateCommand` ã¯æ”¹è¡Œã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ï¼ã²ã¨ã¤ã«ã¯ JSON ã ã‹ã‚‰ï¼ãã—ã¦ã¾ãŸï¼ŒDev Container ã«è¤‡æ•°ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒªã‚¹ãƒˆã§è¨˜è¿°ã§ãã‚‹ã‚ˆã†ãªä»•çµ„ã¿ãŒãªã„ã‹ã‚‰ã§ã™ï¼ã“ã“ã¾ã§ã‚³ãƒãƒ³ãƒ‰ãŒé•·ããªã‚Šç’°å¢ƒå¤‰æ•°ã‚‚ã‚ã‚‹ã¨ãªã‚‹ã¨ï¼Œçµå±€ Dockerfile ã‚’æ›¸ã„ãŸã»ã†ãŒã„ã„ã­ã¨ã„ã†ã“ã¨ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸï¼å®Œæˆã—ãŸ `devcontainer.json` ã¨ `Dockerfile` ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

```json
{
	"name": "Haskell",
	"build": {
		"dockerfile": "Dockerfile"
	},
	"customizations": {
		"vscode": {
			"extensions": [
				"formulahendry.code-runner",
				"mogeko.haskell-extension-pack"
			]
		}
	}
}
```

```Dockerfile
FROM haskell:latest

ENV PATH="${PATH}:/root/.ghcup/bin:/root/.cabal/bin:/root/.ghc/bin" \
    BOOTSTRAP_HASKELL_NONINTERACTIVE=1

RUN curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh

RUN ghcup install ghc 9.8.2 && \
    ghcup install hls 2.7.0.0

RUN cabal update

RUN cabal install hlint
```

# 8. ãŠã‚ã‚Šã«

ã¡ã‚‡ã£ã¨èª¿ã¹ã¦ã¿ã‚‹ã¨ï¼Œã©ã†ã‚„ã‚‰å»ƒæ­¢ã•ã‚Œã‚‹ä»¥å‰ã® Dev Container ã§ã¯ï¼Œä»Šå›èª¬æ˜ã—ãŸã‚ˆã†ãªå•é¡Œã«ã¤ã„ã¦ã¡ã‚ƒã‚“ã¨è§£æ±ºã•ã‚Œã¦ã„ãŸã‚ˆã†ãªã‚“ã§ã™ã‚ˆã­ï¼š

https://github.com/haskell/docker-haskell/issues/76

https://github.com/microsoft/vscode-dev-containers/pull/1478

ãƒªãƒã‚¸ãƒˆãƒªã®ç§»è¡ŒãŒã‚ã£ãŸã¿ãŸã„ã§ï¼Œå»ƒæ­¢ã•ã‚ŒãŸã®ã¯ã“ã®ã¸ã‚“ãŒåŸå› ãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š

https://github.com/microsoft/vscode-dev-containers/issues/1762

ã¾ãŸ Dev Container ã§ç°¡å˜ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ãã‚‹æ—¥ãŒæ¥ã‚‹ã¨ã†ã‚Œã—ã„ã§ã™ã­ï¼
