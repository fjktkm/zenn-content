---
title: "Claude と Codex の認証を永続化する Dev Container Feature"
emoji: "🔐"
type: "tech"
topics: ["devcontainer", "claude", "codex", "gemini"]
published: true
---

:::message
LLM のための本記事の要約

- Dev Container で認証を永続化するにはマウントを使う
- マウントの設定をユーザー側で行う方法は用意されていない
- Features にはマウントを設定する方法がある
- Features は `defaultFeatures` という設定項目がありユーザー側に設定を持たせられる
- Features は簡単に自作できる

:::

:::message
【2026.1.29 追記】
Gemini Code Assist にも対応しました．記事の内容はそのままですが，公開している Feature は更新済みです．
:::

## 1. はじめに

Dev Container で Claude Code や Codex を使う場合，コンテナをリビルドするたびにログインが求められるという問題があります．この記事では，Dev Container 内で Claude Code や Codex の認証情報を永続化する方法について説明します．

## 2. 既存手法

### 2.1. マウントを使う

Dev Container で Codex の認証情報を永続化する方法は Zenn の以下の記事で紹介されています．

https://zenn.dev/gubbai/articles/92bb1398f93f1c

原理は単純で，認証情報が保存されるディレクトリをコンテナ内の所定の場所にマウントすればよい，というものです．ちなみに，この方法は Claude Code にもそのまま適用可能です．

### 2.2. 問題点

しかし，この方法には大きな欠点があります．Dev Container の設定ファイルである `devcontainer.json` を編集する必要があるという点です．ひとつには，`devcontainer.json` はほかの開発者と共有されることが多いため，こうしたマウント設定を含めることは好ましくないということがあります．また，Dev Container を使うすべてのプロジェクトでこの設定を行う必要がある点も問題です．

### 2.3. 類似事例

これと似た問題は VS Code の拡張機能にもあります．たとえば，プロジェクトごとに必要な拡張機能の情報は共有したいが，それ以外に自分だけが使う拡張機能があるという状況です．こちらについては VS Code に機能として用意されており可能です．ユーザー側の `settings.json` に次のように設定すると，プロジェクトに設定された `extensions.json` に加えて，ユーザー側で指定した拡張機能も自動的にインストールされます．

```json
{
  "dev.containers.defaultExtensions": [
    "GitHub.copilot",
    "openai.chatgpt",
    "Anthropic.claude-code",
    "google.geminicodeassist"
  ]
}
```

https://code.visualstudio.com/docs/devcontainers/containers#_always-installed-extensions

一方で，マウントには同様の仕組みが存在しないというのが現状です．

## 3. 提案手法

### 3.1. Features を使う

Dev Container には Features という仕組みがあります．そして，Features には次の 3 つの重要な特性があります．

- `defaultFeatures` という設定項目を用いてユーザー側に設定を持たせられる
- 簡単に自作できる
- マウントを設定する方法がある

### 3.2. `defaultFeatures`

まず `defaultFeatures` について説明します．これは上で紹介した `defaultExtensions` の Dev Container Features 版です．ユーザー側の `settings.json` に次のように設定することで，プロジェクトに設定された Features に加えて，ユーザー側で指定した Features も自動的に有効化されます．

```json
{
  "dev.containers.defaultFeatures": {
    "ghcr.io/devcontainers/features/github-cli:1": {}
  }
}
```

https://code.visualstudio.com/docs/devcontainers/containers#_always-installed-features

### 3.3. 簡単に自作できる

そして Features は簡単に自作できます．作り方は公式のテンプレートリポジトリに詳しく説明されています．これをベースにして作れば簡単に Features を作成・公開できます．

https://github.com/devcontainers/feature-starter

具体的には，`devcontainer-feature.json` という設定ファイルと，必要に応じて `install.sh` などのスクリプトを用意するだけです．以下はテンプレートリポジトリの例です．

https://github.com/devcontainers/feature-starter/tree/main/src/hello

自作 Feature の例として以前見かけたものに，Codex CLI をデフォルトでインストールする Feature があります．

https://x.com/kurusugawa_/status/1948251947217379374

https://github.com/thamaji/devcontainer-features/tree/main/src/codex-cli

これはまさに上述の `defaultFeatures` を使ってユーザー側で有効化することを想定した Feature だと言えます．

### 3.4. マウントの設定

最後にマウントの設定方法について説明します．先ほど説明した `devcontainer-feature.json` でマウントを設定します．書き方は `devcontainer.json` と同様です．たとえば，以下のように設定します．

https://github.com/fjktkm/devcontainer-features/blob/f8ca0726f02967c7dd21d9472924b90c0353b44f/src/agent-creds/devcontainer-feature.json#L6-L11

詳細なルールについては以下の公式ドキュメントに詳しく記載があります．Merge Logic については `Collected list of all mountpoints. Conflicts: Last source wins.` とあり，特に驚きもなく `devcontainer.json` に書いたものと単純にマージされるようです．

https://containers.dev/implementors/features/#:~:text=highlighting%20Feature%20deprecation.-,mounts,-object

https://containers.dev/implementors/spec/#merge-logic

## 4. 実装

以上を踏まえて，Claude Code と Codex の認証情報を永続化する Dev Container Feature を作成しました．詳細な実装内容が知りたい方はソースコードを参照してください．

https://github.com/fjktkm/devcontainer-features

ユーザー側の `settings.json` に次のように設定することで有効化できます．

```json
{
  "dev.containers.defaultFeatures": {
    "ghcr.io/fjktkm/devcontainer-features/agent-persistence:latest": {}
  }
}
```

この Feature を有効化することで，Dev Container のリビルド後も Claude Code と Codex の認証情報が永続化されます．新しいプロジェクトを触ったりリビルドしたりするたびにログインする手間が省けるためなかなか便利だと思います．

ちなみに，一度 `/mnt/.claude` などにマウントしてから `install.sh` で適切な場所にシンボリックリンクを貼るような仕組みを採用しています．これは，任意のコンテナのリモートユーザーに対応するためです．もっとうまい方法はあるかもしれません．

## 5. 考察

### 5.1. Gemini Code Assist では使えない

この記事では Claude Code と Codex を対象にしていますが，というのも Gemini Code Assist はどうやら少し事情が異なるようで単に認証情報が保存されるディレクトリをマウントすればよい，というわけではないようです．あるいは私の検証不足かもしれませんが．

:::message
【2026.1.29 追記】
原因は `.gemini` 以外のフォルダにも認証情報が保存されていたからでした．`.cache/google-vscode-extension` と `.cache/cloud-code` を追加でマウントするようにすることで永続化できました．
:::

### 5.2. セキュリティ面の不安

言われなくてもという話ですが，割とセンシティブな情報を扱うことになるのでセキュリティ面には注意が必要です．自分は技術的検証のために自作 Feature を作成・公開しましたが，実際の運用にあたっては自己責任でお願いします．また，私自身がいうのもあれですが基本的に個人が作成した Feature を信用しない方がよいでしょう．自分の用途に合わせて Feature を自作してみるのも悪い選択肢ではないかもしれません．

### 5.3. API Key を使うタイプの認証方法

この記事で紹介した方法を応用すれば，API Key を使うタイプの認証方法についても同様に永続化できると思います．`devcontainer-feature.json` で環境変数の設定を行えばよいわけです．

## 6. おわりに

Dev Container で Claude Code や Codex の認証情報を永続化する方法について説明しました．Dev Container Features のマウント機能と `defaultFeatures` 設定を組み合わせることで，ユーザー側の設定で認証情報の永続化を実現できました．この記事が同様の課題に直面している方々の参考になれば幸いです．

## ソースコードの公開状況

この記事で紹介した Dev Container Feature のソースコードは以下の GitHub のリポジトリで公開しています．問題点や改善点などがあれば Issue や Pull Request を送って知らせていただけるとうれしいです．

https://github.com/fjktkm/devcontainer-features
