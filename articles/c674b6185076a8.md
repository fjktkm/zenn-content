---
title: "ベクターフォントの機械学習用ライブラリ TorchFont を作った"
emoji: "🧪"
type: "tech"
topics: ["pytorch", "font", "機械学習"]
published: false
---

## 1. はじめに

フォントは印刷物やデジタルデバイスにおいて文字情報を伝達するために重要な役割を果たしています．その制作には多くの時間と労力が必要であり，機械学習による自動生成が期待されています．

既存のフォントに関する機械学習手法は，主に画像生成技術の応用として発達してきました．代表的なものは VAE や GAN を用いた手法であり，これらはビットマップフォントの生成に成功しています．しかし，フォントは様々なスケールで利用されるため解像度に依存しないベクター形式が主流であり，ビットマップ形式での生成には実用性が低いという課題があります．

ベクターフォントの生成の研究があまり進展していない背景のひとつには，ベクターフォント特有のデータ構造に対応した機械学習用ライブラリが不足していることが挙げられます．そこで，わたしは PyTorch ベースのベクターフォント用ドメイン特化ライブラリ TorchFont を開発しました．この記事では，TorchFont の設計理念や機能について紹介します．

## 2. 既存手法

### 2.1. DeepSVG のデータセット

ベクター画像の生成に取り組んだ初期の研究に DeepSVG があります．DeepSVG ではベクター画像だけでなくベクターフォントの生成にも取り組んでおり，ソースコードとともにデータセットが公開されています（厳密にはその先行研究の SVG-VAE のデータセットです）．

https://alexandre01.github.io/deepsvg/

https://github.com/alexandre01/deepsvg

ここで，DeepSVG のフォントデータセットと，Google Fonts のデータセットを比較すると以下のようになります．

|              | フォントフェイス数 |   文字種数 |  総サンプル数 |
| :----------: | -----------------: | ---------: | ------------: |
|   DeepSVG    |             45,821 |         62 |       100,000 |
| Google Fonts |           約 9,000 | 約 110,000 | 約 12,000,000 |

Google Fonts はフォント数こそ少ないものの，サンプル数において約 120 倍もの差があります．また，DeepSVG のデータセットは英数字のみであるのに対し，Google Fonts にはそうした制限がありません．特に日本語を含む多言語フォントの生成を考えると，DeepSVG のデータセットでは不十分だと言わざるを得ないでしょう．

### 2.2. TTFQuery および fontTools

ベクターフォントのアウトラインを取り出すためのライブラリとして TTFQuery があります．TTFQuery は Python の fontTools をラップしたライブラリであり，フォントのアウトライン情報を簡単に取得できます．

https://github.com/mcfletch/ttfquery

そもそも fontTools はフォント開発の現場でも使用される汎用的で強力なライブラリであり，フォントの解析や編集など様々な機能を提供しています．別に TTFQuery を使用せずとも，fontTools を直接利用することでフォントのアウトライン情報を取得することも可能です．詳しくは fontTools の Pen プロトコルなどを参照するとよいでしょう．

https://github.com/fonttools/fonttools

一方で，fontTools を使用した方法には問題点があります．問題点は大きく以下の 2 つです．

- メモリ使用量が多い
- パーサーの処理速度が遅い

具体的には，Google Fonts に含まれるすべてのフォントを読み込むのに，メモリを 30 GB 程度要します．これでパース速度が速ければ毎回パースしてもよいのですが，処理速度も遅いためメモリに保持し続ける必要があります．

また，フォントファイルのパース結果はマルチプロセスで共有できないため，Dataloader で `num_workers` を増やす場合 `num_workers` 倍のメモリが必要になります．これが特に致命的で，マシンのメモリ容量が限られている場合，Dataloader がボトルネックになってしまいます．DeepSVG などにおいてオンザフライで処理せずあらかじめデータセットを構築しているもの，このあたりの問題が原因なのではないかと推測しています．

これらは fontTools が汎用的であるがゆえの問題点で，fontTools に文句を言うのは筋違いですが，とはいえ機械学習の分野で使用するにはやや不向きな面があることは否めません．
