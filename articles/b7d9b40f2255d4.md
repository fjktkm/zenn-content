---
title: "大学のホスティングサービスでも CI/CD したい"
emoji: "🤖"
type: "tech"
topics: ["github", "githubactions", "cicd"]
published: false
---

この記事では，GitHub の Self Hosted Runner を用いて Web サイトのデプロイを自動化した話をします．ホスティングする Web サイトは，わたしの所属する名古屋工業大学コンピュータ俱楽部 NITMic の公式サイトです．ホスティングサービスは，大学の提供する課外活動団体向けのホスティングサービスを利用しています．大学のように制約のあるネットワークにおいて CI/CD したい場合の参考になれば幸いです．

:::message
名工大特有の事情についても言及しています．これは大学の後輩が見ることを想定しているためです．興味がない場合は読み飛ばしてください．
:::

## 1. はじめに

NITMic では，大学の提供するホスティングサービスを利用しています：

https://nitmic.club.nitech.ac.jp/

このホスティングサービスは，セキュリティ上の観点から大学のネットワークからしかアクセスできないように設定されています．学外からアクセスする場合は VPN に接続する必要があるのですが，VPN の接続には Microsoft Authenticator による認証が必要であるため自動化は不可能

また，公式サイトについては HUGO を利用して構築しています．

また，学生団体特有の事情として，独自にサーバを立てて管理することは避けたいと考えていました．

## 2. 背景

大学の提供するホスティングサービスには，CI/CD を実現できそうないくつかの機能があります．

- Git 連携機能
- SSH 接続
- ホスティングタイプを転送に設定
- GitHub Pages のカスタムドメイン

しかし，これらの手法はことごとく失敗に終わります．

### 2.1. Git 連携機能

Git 連携機能とはなんぞやという話ですが，ざっくりと言えば GitHub のリポジトリに Push があったときに Webhook をトリガーにホスティングサーバ側でで Pull するというものです．

第一に，この方法にはビルドに関する問題があります．この機能で実現するのは Pull だけなので，通常ならホスティングサーバ上でビルドする必要があります．しかし，ホスティングサーバにはもちろん HUGO はインストールされておらず，またインストールする権限もありません．したがって，ビルド済みファイルを Orphan ブランチなどに忍ばせるといった面倒なことをする必要があるのです．

https://engawapg.net/software-development/2393/github-pages-branch/

第二に，これが致命的ではあるのですが，Webhook の受信エンドポイントに対するアクセスはホスティングサーバへのアクセスということになります．したがって，GitHub などの学外ネットワークからはアクセスできません．このことに気づかないと，Webhook を設定したのにうまく機能しないという沼にはまります（一敗）．

### 2.2. SSH 接続

出オチなのですが，SSH 接続には VPN 接続が必要です．無理でした．

### 2.3. ホスティングタイプを転送に設定

ホスティングタイプの転送というのがどのような機能かというと，`iframe` 要素で転送先に指定した Web サイトを表示するというものです．したがって，Web サイトを GitHub Pages でデプロイして，これを転送先に指定することによりデプロイの自動化を図るというわけです．

残念ながら，この方法もうまく機能しませんでした．おそらくセキュリティ上の理由からなんらかの制限がかけられているものと思われます．

### 2.4. GitHub Pages のカスタムドメイン

これも GitHub Pages を利用する方法です．GitHub Pages にはカスタムドメインを設定する機能があります．このカスタムドメインに `nitmic.club.nitech.ac.jp` を利用すればいいというわけです．

残念ながら，この方法もうまく機能しませんでした．この方法には DNS 情報の書き換えが必要です．幸い DNS 情報の編集自体は可能でした．しかし，いざ管理画面から DNS 情報を編集してみても変更が反映されません．DNS 情報の変更の反映には時間がかかります（浸透と言うと怒られが発生するあれ）．単純に設定にミスがあるのか，時間の問題なのか，何が原因なのかわからりません．結局，サブドメインに権限が委譲されていないのが原因でした．学生ごときが DNS 情報をいじれるわけがなかったのです．

### 2.5. ポート開放

さんざっぱら言ってきたように，VPN 接続がひとつデプロイの自動化を阻む大きな要素になっています．逆に言えば，ここさえクリアすればどうにかなりそうな予感がありました．そこで，大学側に 22/ssh のポート開放を依頼してみることにしました．返答は IP アドレスで制限したいというものでした．まぁそれはそうですよね．しかしそれが困ったことに，GitHub Actions の Runner は IP アドレスは非常に広大でかつ不定です．したがって，ポート開放という奥の手をもってしてもデプロイの自動化は実現できないのでした．

## 3. 方法

## 実験

## 結果

## 考察

## 結論
