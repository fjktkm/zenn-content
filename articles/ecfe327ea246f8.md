---
title: "ZIP ファイル用の Git カスタムマージドライバを作ってみた"
emoji: "🌳"
type: "tech"
topics: ["git", "zip"]
published: false
---

:::message
これはメッセージです．
あああ
:::

# 1. はじめに

世の中にはソースコード以外にも Git で管理できたらうれしいものがあります：

- 画像ファイル
- Microfot Word のファイル
- Microsoft PowerPoint のファイル
- Adobe のファイル
- Affinity のファイル

しかしこれらはバイナリファイルなので，通常の Git ではうまくマージすることができません．マージできないのに Git で管理しようとすると悲惨な結果になります（経験談）．

そういうわけで，バイナリファイルのマージ方法ってカスタムできないのかな？と調べてみました．すると，どうやらカスタムマージドライバというものが設定できるらしいということがわかりました．そこで，試しに ZIP ファイル用のカスタムマージドライバを作ってみることにしました．

:::message
実は，Word や PowerPoint のファイルの中身は，ZIP 形式のアーカイブだったりします．なので，拡張子を `.zip` に変更して展開すると中身が簡単に見れちゃいます．ほかにも Windows アプリケーションのインストーラとかでよく見かける `.msi` も同じように ZIP で展開できます．いろいろ試してみると面白いかもしれません．
:::

https://www.pc-koubou.jp/magazine/29944

# 2. カスタムマージドライバの使い方

カスタムマージドライバを使うにはいろいろやることがあります：

- Git リポジトリにカスタムマージドライバを設定する
- カスタムマージドライバを作る
- `.gitattiributes` で適用ファイルを指定する

# 3. Git リポジトリへの設定

Git リポジトリへの設定は以下のようなコマンドで行います：

```
git config merge.zipmerge.name "Custom merge driver for zip files"
git config merge.zipmerge.driver "/workspaces/zip-merge-driver/src/main.sh %O %A %B %P"
```

`zipmerge` の部分に好きな識別名を入れて，`name` と `driver` を設定します．`driver` は実行したいコマンドを設定すればよいみたいです．ここでは Shellscript で記述したものを設定しています．引数については Git の仕様に準じた内容になっていて，以下のような条件らしいです：

- %O : ブランチが分岐したときの状態のファイル名
- %A : 現在のブランチのファイル名
- %B : マージ対象のブランチのファイル名
- %P : マージ結果のファイル名

言われてみれば大したことはない仕組みなのですが，`%O`, `%A`, `%B` の部分にマージするファイルのファイル名が渡されて，これ実際にリポジトリのルート直下に生成されます．ファイルのパスは `path/to/repo/%O` というような形になります．これらのファイルを参照してマージした結果を `path/to/repo/%P` に書き出すソースコードを作れば，Git がそれをマージ結果として処理してくれるということになります．

:::message
カスタムマージドライバが呼び出されるのは，現在のブランチとマージ対象のブランチの両方で変更があった場合のみです．高々一方だけしか変更がなかった場合には，そもそもその変更があったほうを採用するだけでいいのでカスタムマージドライバは呼び出されません．
:::

# 4. カスタムマージドライバを作る

さてさて，仕組みが分かったところで，カスタムマージドライバを作ります．ここまで聞けば，カスタムマージドライバが Shellscript でも書けるというのも頷けるのかなと思います．

今回作るのは ZIP ファイル用のカスタムマージドライバです．ZIP ファイルは Git では画像ファイルと同じようにバイナリとして処理されます．そのため，コンフリクトした場合にはどちらかのブランチのものを採用する二者択一になってしまいます．そうではなく，ZIP ファイルの中身で差分をとってマージすると面白いのではないか．ということで，ZIP ファイルを展開しその中身をマージし再び圧縮したものをマージ結果とするカスタムマージドライバを作ることにしました．

# . 付録

作成したリポジトリはこちら：

https://github.com/fjktkm/zip-merge-driver

# . 参考文献

ChatGPT がなぜかカスタムマージドライバについて詳しかったので，ほとんど ChatGPT とおしゃべりして作りました．一応参考になりそうな記事を挙げておきます：

https://qiita.com/OmeletteCurry19/items/26b9bc6ef3706760a9cb
